<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
    <title>Gabriel's Homeschool Record</title>
    
    <!-- Google Fonts: Inter & Outfit -->
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;700;900&family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- jsPDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>

    <style>
        :root {
            --bg-page: #ffffff;
            --neon-blue: #00f2ea;
            --neon-pink: #ff0055;
            --neon-purple: #bd00ff;
            --neon-yellow: #ffec19;
            --neon-green: #00ff9d;
        }

        body, html {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-page);
            color: #18181b;
            height: 100%;
            overflow: hidden;
        }

        h1, h2, h3, button, label {
            font-family: 'Outfit', sans-serif;
        }

        /* Bright Rainbow Text */
        .rainbow-text {
            background: linear-gradient(90deg, #ff0055, #bd00ff, #00f2ea);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-weight: 900;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));
        }

        /* Inputs - FORCED WHITE */
        .neon-input {
            width: 100%;
            background-color: #ffffff !important;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 10px 12px;
            font-weight: 600;
            color: #1e293b;
            transition: all 0.2s;
        }
        .neon-input:focus {
            outline: none;
            border-color: var(--neon-purple);
            box-shadow: 0 0 0 4px rgba(189, 0, 255, 0.1);
        }

        /* Toggle */
        .toggle-container {
            background: #f1f5f9;
            padding: 6px;
            border-radius: 999px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            position: relative;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.05);
        }
        .tab-bg {
            position: absolute;
            top: 6px; bottom: 6px; left: 6px;
            width: calc(50% - 6px);
            background: #fff;
            border-radius: 999px;
            border: 2px solid var(--neon-blue);
            box-shadow: 0 4px 12px rgba(0, 242, 234, 0.2);
            transition: transform 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 0;
        }
        .tab-btn { position: relative; z-index: 1; color: #64748b; transition: color 0.2s; }
        .tab-btn.active { color: #0f172a; font-weight: 900; }

        /* Save Button - High Energy */
        .btn-neon {
            background: linear-gradient(135deg, var(--neon-pink), var(--neon-purple));
            color: white;
            box-shadow: 0 8px 20px rgba(255, 0, 85, 0.3);
            transition: all 0.2s;
            border: 2px solid white;
        }
        .btn-neon:active { transform: scale(0.98); }

        /* Timeline Card */
        .timeline-card {
            background: #ffffff;
            border: 2px solid #f1f5f9;
            border-radius: 16px;
            overflow: hidden;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
        }
        .timeline-card:hover {
            border-color: var(--neon-blue);
            transform: translateY(-2px);
            box-shadow: 0 10px 25px -5px rgba(0, 242, 234, 0.15);
        }
        .timeline-details {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out, padding 0.3s ease;
            background: #f8fafc;
        }
        .expanded .timeline-details {
            max-height: 800px;
            padding: 1.5rem;
            border-top: 2px solid #f1f5f9;
        }
        .chevron { transition: transform 0.3s; }
        .expanded .chevron { transform: rotate(180deg); }

        /* Unit Header */
        .unit-header {
            margin-top: 24px;
            margin-bottom: 12px;
            padding-bottom: 4px;
            border-bottom: 2px solid #f1f5f9;
            font-family: 'Outfit', sans-serif;
            font-weight: 900;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Scrollbar */
        .scroller::-webkit-scrollbar { width: 6px; }
        .scroller::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .scroller::-webkit-scrollbar-track { background: transparent; }

        input[type="date"] {
            font-family: 'Inter', sans-serif;
            font-weight: 700;
        }
    </style>
</head>
<body class="flex flex-col h-screen">

    <!-- HEADER -->
    <header class="bg-white border-b border-slate-100 py-4 px-4 shrink-0 z-20">
        <div class="max-w-2xl mx-auto flex items-center justify-between">
            <h1 class="text-3xl tracking-tighter rainbow-text">GABRIEL'S LOG</h1>
            
            <!-- Global Date Filter (For Viewing) -->
            <div class="flex items-center bg-slate-50 rounded-xl border border-slate-200 p-1">
                <button id="prev-date" class="p-2 text-slate-400 hover:text-indigo-600 hover:bg-white rounded-lg transition"><i data-lucide="chevron-left" class="w-6 h-6"></i></button>
                <div class="px-4 text-center min-w-[120px]">
                    <span id="date-display-text" class="text-base font-black text-slate-800 block">Today</span>
                </div>
                <button id="next-date" class="p-2 text-slate-400 hover:text-indigo-600 hover:bg-white rounded-lg transition"><i data-lucide="chevron-right" class="w-6 h-6"></i></button>
            </div>
        </div>
    </header>

    <!-- TABS -->
    <div class="bg-white px-4 py-4 shrink-0 z-10 shadow-sm">
        <div class="max-w-2xl mx-auto toggle-container">
            <div id="tab-bg" class="tab-bg"></div>
            <button onclick="switchTab('write')" id="tab-write" class="tab-btn active py-3 text-sm font-black text-center rounded-full tracking-wide">
                LOG ENTRY
            </button>
            <button onclick="switchTab('review')" id="tab-review" class="tab-btn py-3 text-sm font-black text-center rounded-full flex items-center justify-center gap-2 tracking-wide">
                VIEW RECORDS
            </button>
        </div>
    </div>

    <!-- MAIN CONTENT -->
    <main class="flex-1 overflow-hidden relative bg-white">
        <div class="max-w-2xl mx-auto h-full relative">
            
            <!-- WRITE VIEW -->
            <div id="view-write" class="absolute inset-0 overflow-y-auto scroller p-6 pb-32">
                <form id="journal-form" class="space-y-6">
                    
                    <!-- Date & Subject Row (Header) -->
                    <div class="grid grid-cols-2 gap-4">
                        <div class="space-y-2">
                            <label class="text-xs font-black text-indigo-500 uppercase ml-1 tracking-wider">DATE TAUGHT</label>
                            <input type="date" id="input-date" class="neon-input cursor-pointer text-lg border-indigo-200" required>
                        </div>
                        <div class="space-y-2">
                            <label class="text-xs font-black text-slate-400 uppercase ml-1 tracking-wider">Subject</label>
                            <div class="relative">
                                <select id="input-subject" class="neon-input appearance-none cursor-pointer text-lg">
                                    <option value="Math">Math</option>
                                    <option value="Language Arts">Language Arts</option>
                                    <option value="Science">Science</option>
                                    <option value="History">History</option>
                                    <option value="Geography">Geography</option>
                                    <option value="Art">Art</option>
                                    <option value="Music">Music</option>
                                    <option value="PE">PE</option>
                                    <option value="Reading">Reading</option>
                                    <option value="Technology">Technology</option>
                                    <option value="Life Skills">Life Skills</option>
                                    <option value="Other">Other</option>
                                </select>
                                <i data-lucide="chevron-down" class="absolute right-4 top-1/2 -translate-y-1/2 w-5 h-5 text-slate-400 pointer-events-none"></i>
                            </div>
                        </div>
                    </div>

                    <!-- Type Selection -->
                    <div class="grid grid-cols-3 gap-4">
                        <label class="cursor-pointer group">
                            <input type="radio" name="entryType" value="daily" class="peer hidden" checked>
                            <div class="py-3 text-center text-sm font-bold border-2 border-slate-100 bg-white rounded-2xl text-slate-400 peer-checked:border-[#00f2ea] peer-checked:text-[#00c2bb] peer-checked:bg-cyan-50 transition-all shadow-sm">Daily</div>
                        </label>
                        <label class="cursor-pointer group">
                            <input type="radio" name="entryType" value="weekly" class="peer hidden">
                            <div class="py-3 text-center text-sm font-bold border-2 border-slate-100 bg-white rounded-2xl text-slate-400 peer-checked:border-[#bd00ff] peer-checked:text-[#a200db] peer-checked:bg-purple-50 transition-all shadow-sm">Weekly</div>
                        </label>
                        <label class="cursor-pointer group">
                            <input type="radio" name="entryType" value="unit" class="peer hidden">
                            <div class="py-3 text-center text-sm font-bold border-2 border-slate-100 bg-white rounded-2xl text-slate-400 peer-checked:border-[#ff0055] peer-checked:text-[#db0049] peer-checked:bg-pink-50 transition-all shadow-sm">Unit</div>
                        </label>
                    </div>

                    <!-- Category & Unit -->
                    <div class="grid grid-cols-2 gap-4">
                        <div class="space-y-2">
                            <label class="text-xs font-black text-slate-400 uppercase ml-1 tracking-wider">Work Type</label>
                            <input id="input-category" list="category-list" class="neon-input" value="Lesson">
                            <datalist id="category-list">
                                <option value="Worksheet"></option>
                                <option value="Lesson"></option>
                                <option value="Project"></option>
                                <option value="Quiz"></option>
                                <option value="Reading"></option>
                                <option value="Video"></option>
                            </datalist>
                        </div>
                        <div class="space-y-2">
                            <label class="text-xs font-black text-slate-400 uppercase ml-1 tracking-wider">Unit / Module Name</label>
                            <input type="text" id="input-unit" class="neon-input" placeholder="e.g. Solar System">
                        </div>
                    </div>

                    <!-- TOPIC LINE -->
                    <div class="space-y-2 pt-2 border-t border-slate-100">
                        <label class="text-xs font-black text-indigo-500 uppercase ml-1 tracking-wider">Topic / Lesson Name</label>
                        <input type="text" id="input-topic" class="neon-input text-lg font-bold text-indigo-700 bg-indigo-50" placeholder="e.g. The Sun's Gravity">
                    </div>

                    <div class="space-y-2">
                        <label class="text-xs font-black text-slate-400 uppercase ml-1 tracking-wider">Activity Details / Description</label>
                        <textarea id="input-details" class="neon-input min-h-[100px] resize-none text-base" placeholder="What specifically did we do?" required></textarea>
                    </div>

                    <!-- Assignments & Notes -->
                    <div class="grid grid-cols-1 gap-4 bg-slate-50 p-6 rounded-2xl border border-slate-100">
                        <div class="space-y-2">
                            <label class="text-xs font-black text-[#00c2bb] uppercase ml-1 flex items-center gap-2"><i data-lucide="check-square" class="w-4 h-4"></i> Assignments Completed</label>
                            <input type="text" id="input-assignments" class="neon-input bg-white border-slate-200" placeholder="pg. 42 #1-5">
                        </div>
                        <div class="space-y-2">
                            <label class="text-xs font-black text-[#db0049] uppercase ml-1 flex items-center gap-2"><i data-lucide="sticky-note" class="w-4 h-4"></i> Observations / Notes</label>
                            <input type="text" id="input-notes" class="neon-input bg-white border-slate-200" placeholder="Progress notes...">
                        </div>
                    </div>

                    <div class="pt-4">
                        <button type="submit" id="save-btn" class="btn-neon w-full py-3 rounded-2xl text-lg font-black tracking-widest uppercase flex items-center justify-center gap-3">
                            <i data-lucide="save" class="w-5 h-5"></i> SAVE RECORD
                        </button>
                    </div>
                </form>
            </div>

            <!-- REVIEW VIEW (Timeline) -->
            <div id="view-review" class="absolute inset-0 overflow-y-auto scroller p-6 pb-32 hidden bg-white">
                
                <div class="flex justify-between items-center mb-8">
                    <h2 class="text-2xl font-black text-slate-800 tracking-tight">RECORDS</h2>
                    <div class="flex gap-2">
                        <select id="view-filter" onchange="setView(this.value)" class="bg-slate-100 text-slate-700 border-none text-sm font-bold rounded-xl px-4 py-3 outline-none cursor-pointer hover:bg-slate-200 transition">
                            <option value="daily">Daily View</option>
                            <option value="subject">By Subject</option>
                            <option value="unit">By Unit (Flow)</option>
                            <option value="all">Full History</option>
                        </select>
                        <button id="btn-pdf" class="hidden bg-slate-800 text-white p-3 rounded-xl hover:bg-slate-700 transition shadow-lg shadow-slate-200" title="Print Official Record">
                            <i data-lucide="printer" class="w-5 h-5"></i>
                        </button>
                    </div>
                </div>

                <div id="timeline-container" class="space-y-4">
                    <!-- Dynamic Content -->
                </div>
                
                <div id="empty-state" class="hidden flex flex-col items-center justify-center py-20 opacity-50">
                    <div class="w-20 h-20 bg-slate-100 rounded-full flex items-center justify-center mb-4">
                        <i data-lucide="book-open" class="w-10 h-10 text-slate-300"></i>
                    </div>
                    <p class="font-bold text-slate-400 text-lg">No records found.</p>
                </div>
            </div>
            
            <!-- Cancel Overlay -->
            <button type="button" id="cancel-edit-btn" class="hidden fixed bottom-6 left-1/2 -translate-x-1/2 bg-rose-600 text-white px-8 py-3 rounded-full shadow-[0_10px_30px_rgba(225,29,72,0.4)] font-black tracking-wide z-50 cursor-pointer hover:scale-105 transition-transform border-4 border-white active:scale-95" onclick="cancelEdit()">
                CANCEL EDIT
            </button>

        </div>
    </main>

    <!-- FIREBASE & LOGIC -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, deleteDoc, setDoc, doc, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyCBGNaOM_gv8X2DZZqAija6XakbdaTorS0",
            authDomain: "e-notion.firebaseapp.com",
            projectId: "e-notion",
            storageBucket: "e-notion.firebasestorage.app",
            messagingSenderId: "668075829380",
            appId: "1:668075829380:web:d31d7e74209e2f44e9bad1",
            measurementId: "G-X09RV55WSD"
        };
        const appId = 'e-notion'; 

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const state = {
            user: null,
            entries: [],
            rawUser: [],
            rawPublic: [],
            activeTab: 'write',
            viewMode: 'daily',
            viewDate: new Date().toISOString().split('T')[0],
            editingId: null,
            isSaving: false
        };

        // AUTH
        signInAnonymously(auth).catch(err => console.error(err));

        onAuthStateChanged(auth, (user) => {
            state.user = user;
            if(user) {
                const userRef = collection(db, 'artifacts', appId, 'users', user.uid, 'daily_journal');
                const publicRef = collection(db, 'artifacts', appId, 'public', 'data', 'daily_journal');
                
                onSnapshot(userRef, (s) => { state.rawUser = s.docs.map(d => ({id: d.id, ...d.data()})); refresh(); });
                onSnapshot(publicRef, (s) => { state.rawPublic = s.docs.map(d => ({id: d.id, ...d.data()})); refresh(); });
            }
        });

        function refresh() {
            const all = [...state.rawUser, ...state.rawPublic];
            const unique = Array.from(new Map(all.map(item => [item.id, item])).values());
            
            // Default Sort: Date DESC, then Time DESC
            unique.sort((a, b) => {
                if(a.date > b.date) return -1;
                if(a.date < b.date) return 1;
                const ta = a.createdAt?.seconds || 0;
                const tb = b.createdAt?.seconds || 0;
                return tb - ta;
            });

            state.entries = unique;
            updateUI();
        }

        function updateUI() {
            document.getElementById('btn-pdf').classList.toggle('hidden', state.entries.length === 0);
            if(state.activeTab === 'review') renderTimeline();
        }

        window.switchTab = (tab) => {
            state.activeTab = tab;
            const bg = document.getElementById('tab-bg');
            const btnWrite = document.getElementById('tab-write');
            const btnReview = document.getElementById('tab-review');
            const viewWrite = document.getElementById('view-write');
            const viewReview = document.getElementById('view-review');

            if(tab === 'write') {
                bg.style.transform = 'translateX(0)';
                btnWrite.classList.add('active');
                btnReview.classList.remove('active');
                viewWrite.classList.remove('hidden');
                viewReview.classList.add('hidden');
            } else {
                bg.style.transform = 'translateX(100%)';
                btnWrite.classList.remove('active');
                btnReview.classList.add('active');
                viewWrite.classList.add('hidden');
                viewReview.classList.remove('hidden');
                renderTimeline();
            }
        };

        window.toggleDetails = (id) => {
            const card = document.getElementById(`card-${id}`);
            if(card) card.classList.toggle('expanded');
        }

        window.setView = (mode) => {
            state.viewMode = mode;
            renderTimeline();
        }

        window.cancelEdit = () => {
            state.editingId = null;
            document.getElementById('save-btn').innerHTML = `<i data-lucide="save" class="w-5 h-5"></i> SAVE RECORD`;
            document.getElementById('cancel-edit-btn').classList.add('hidden');
            document.getElementById('journal-form').reset();
            document.getElementById('input-date').value = state.viewDate;
            if(window.lucide) window.lucide.createIcons();
        }

        // DATE LOGIC
        function setViewDate(iso) {
            state.viewDate = iso;
            const d = new Date(iso + 'T12:00:00');
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('date-display-text').innerText = (iso === today) ? 'Today' : d.toLocaleDateString('en-US', {month:'short', day:'numeric'});
            
            // Only update form date if NOT in edit mode
            if(!state.editingId) {
                document.getElementById('input-date').value = iso;
            }
            updateUI();
        }
        
        // Init
        document.getElementById('input-date').value = state.viewDate;
        setViewDate(state.viewDate);

        document.getElementById('prev-date').onclick = () => {
            const d = new Date(state.viewDate); d.setDate(d.getDate()-1);
            setViewDate(d.toISOString().split('T')[0]);
        };
        document.getElementById('next-date').onclick = () => {
            const d = new Date(state.viewDate); d.setDate(d.getDate()+1);
            setViewDate(d.toISOString().split('T')[0]);
        };

        // SAVE
        document.getElementById('journal-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            if(state.isSaving || !state.user) return;
            state.isSaving = true;
            
            const btn = document.getElementById('save-btn');
            const originalHTML = btn.innerHTML;
            btn.innerText = "SAVING...";

            // Capture the date explicitly from the form input
            const formDate = document.getElementById('input-date').value;

            const entry = {
                date: formDate, 
                type: document.querySelector('input[name="entryType"]:checked').value,
                subject: document.getElementById('input-subject').value,
                category: document.getElementById('input-category').value,
                unit: document.getElementById('input-unit').value,
                topic: document.getElementById('input-topic').value,
                details: document.getElementById('input-details').value, 
                assignments: document.getElementById('input-assignments').value,
                notes: document.getElementById('input-notes').value,
                updatedAt: serverTimestamp()
            };

            try {
                if(state.editingId) {
                    await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'daily_journal', state.editingId), entry, {merge:true});
                    state.editingId = null;
                    document.getElementById('cancel-edit-btn').classList.add('hidden');
                } else {
                    entry.createdAt = serverTimestamp();
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'daily_journal'), entry);
                }

                // *** CRITICAL FIX: JUMP VIEW TO THE SAVED DATE ***
                setViewDate(formDate);

                // Reset specific fields, leave context
                document.getElementById('input-topic').value = '';
                document.getElementById('input-details').value = '';
                document.getElementById('input-assignments').value = '';
                document.getElementById('input-notes').value = '';
                
                btn.innerText = "RECORD SAVED!";
                setTimeout(() => {
                    btn.innerHTML = `<i data-lucide="save" class="w-5 h-5"></i> SAVE RECORD`;
                    if(window.lucide) window.lucide.createIcons();
                }, 1500);

            } catch(err) {
                alert("Error: " + err.message);
                btn.innerHTML = originalHTML;
            } finally {
                state.isSaving = false;
            }
        });

        // EDIT & CONTINUE
        window.editEntry = (id) => {
            const item = state.entries.find(e => e.id === id);
            if(!item) return;
            event.stopPropagation();

            state.editingId = id;
            document.getElementById('input-date').value = item.date;
            
            const radio = document.querySelector(`input[name="entryType"][value="${item.type || 'daily'}"]`);
            if(radio) radio.checked = true;

            document.getElementById('input-subject').value = item.subject;
            document.getElementById('input-category').value = item.category;
            document.getElementById('input-unit').value = item.unit;
            document.getElementById('input-topic').value = item.topic;
            document.getElementById('input-details').value = item.details || ''; 
            document.getElementById('input-assignments').value = item.assignments;
            document.getElementById('input-notes').value = item.notes;

            document.getElementById('save-btn').innerText = "UPDATE RECORD";
            document.getElementById('cancel-edit-btn').classList.remove('hidden');
            
            switchTab('write');
        };

        window.continueUnit = (id) => {
            const item = state.entries.find(e => e.id === id);
            if(!item) return;
            event.stopPropagation();

            state.editingId = null; 
            document.getElementById('cancel-edit-btn').classList.add('hidden'); 
            document.getElementById('save-btn').innerHTML = `<i data-lucide="save" class="w-5 h-5"></i> SAVE RECORD`;

            // Default to Today for new entry
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('input-date').value = today;
            
            document.getElementById('input-subject').value = item.subject;
            document.getElementById('input-category').value = item.category;
            document.getElementById('input-unit').value = item.unit; // Keep Unit
            
            document.getElementById('input-topic').value = ''; // New Topic
            document.getElementById('input-details').value = ''; // New Details
            document.getElementById('input-assignments').value = '';
            document.getElementById('input-notes').value = '';

            switchTab('write');
        };

        window.deleteEntry = async (id) => {
            event.stopPropagation();
            if(confirm("Delete this record?")) {
                await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'daily_journal', id));
                if(state.user) await deleteDoc(doc(db, 'artifacts', appId, 'users', state.user.uid, 'daily_journal', id)).catch(e=>{});
            }
        };

        // RENDER LOGIC
        function renderTimeline() {
            const container = document.getElementById('timeline-container');
            const empty = document.getElementById('empty-state');
            
            let data = [...state.entries];
            
            if(state.viewMode === 'daily') {
                data = data.filter(e => e.date === state.viewDate);
            }
            else if(state.viewMode === 'subject') {
                data = data.filter(e => e.date === state.viewDate);
                data.sort((a,b) => a.subject.localeCompare(b.subject));
            }
            else if(state.viewMode === 'unit') {
                // Group by Unit Name alphabetically
                data.sort((a,b) => (a.unit || "").localeCompare(b.unit || ""));
            }

            if(data.length === 0) {
                container.innerHTML = '';
                empty.classList.remove('hidden');
                return;
            }
            empty.classList.add('hidden');

            let lastUnit = null;

            container.innerHTML = data.map(item => {
                let headerHTML = '';
                if(state.viewMode === 'unit') {
                    const currentUnit = item.unit || "Uncategorized";
                    if(currentUnit !== lastUnit) {
                        headerHTML = `<div class="unit-header"><i data-lucide="layers" class="w-4 h-4 text-indigo-400"></i> ${currentUnit}</div>`;
                        lastUnit = currentUnit;
                    }
                }

                let bgIcon = "bg-slate-100";
                let textIcon = "text-slate-500";
                let icon = "circle";
                
                const s = item.subject || 'Other';
                if(s.includes("Math")) { bgIcon = "bg-cyan-50"; textIcon="text-[#00c2bb]"; icon="calculator"; }
                else if(s.includes("Science")) { bgIcon = "bg-green-50"; textIcon="text-emerald-500"; icon="flask-conical"; }
                else if(s.includes("History")) { bgIcon = "bg-orange-50"; textIcon="text-orange-500"; icon="landmark"; }
                else if(s.includes("Language")) { bgIcon = "bg-pink-50"; textIcon="text-[#db0049]"; icon="feather"; }
                else if(s.includes("Reading")) { bgIcon = "bg-purple-50"; textIcon="text-[#a200db]"; icon="book-open"; }
                else if(s.includes("Tech")) { bgIcon = "bg-blue-50"; textIcon="text-blue-600"; icon="cpu"; }

                const dateDisplay = `<span class="text-[10px] font-bold text-slate-400 bg-slate-50 px-2 py-0.5 rounded-md whitespace-nowrap">${item.date}</span>`;

                return `
                    ${headerHTML}
                    <div class="timeline-card cursor-pointer group mb-4" id="card-${item.id}" onclick="toggleDetails('${item.id}')">
                        <div class="p-5 flex items-center justify-between">
                            <div class="flex items-center gap-4">
                                <div class="w-12 h-12 rounded-2xl ${bgIcon} flex items-center justify-center ${textIcon} shadow-sm shrink-0">
                                    <i data-lucide="${icon}" class="w-6 h-6"></i>
                                </div>
                                <div class="overflow-hidden">
                                    <div class="flex items-center gap-2 mb-1">
                                        <span class="text-[10px] font-black uppercase text-slate-500 bg-slate-100 px-2 py-0.5 rounded-md tracking-wider whitespace-nowrap">${item.subject}</span>
                                        ${dateDisplay}
                                    </div>
                                    
                                    <div class="flex flex-col">
                                        ${item.unit ? `<span class="text-[10px] font-bold text-slate-400 uppercase tracking-wide mb-0.5">${item.unit}</span>` : ''}
                                        <h3 class="font-bold text-slate-800 text-base truncate">${item.topic || 'Untitled Lesson'}</h3>
                                    </div>
                                </div>
                            </div>
                            <div class="flex items-center gap-3">
                                <button onclick="continueUnit('${item.id}')" class="w-8 h-8 flex items-center justify-center rounded-full bg-slate-50 text-slate-400 hover:bg-indigo-50 hover:text-indigo-600 transition-colors" title="Log another activity for this unit">
                                    <i data-lucide="arrow-right-circle" class="w-5 h-5"></i>
                                </button>
                                <i data-lucide="chevron-down" class="w-5 h-5 text-slate-400 chevron group-hover:text-indigo-600 transition-colors"></i>
                            </div>
                        </div>

                        <div class="timeline-details">
                            <div class="flex justify-end gap-3 mb-4">
                                <button onclick="editEntry('${item.id}')" class="text-xs font-black text-indigo-600 hover:text-indigo-800 uppercase bg-indigo-50 px-3 py-1.5 rounded-lg transition-colors">Edit Record</button>
                                <button onclick="deleteEntry('${item.id}')" class="text-xs font-black text-rose-600 hover:text-rose-800 uppercase bg-rose-50 px-3 py-1.5 rounded-lg transition-colors">Delete</button>
                            </div>

                            <h4 class="text-xs font-black text-slate-400 uppercase mb-2 tracking-wider">Activity Details</h4>
                            <p class="text-sm text-slate-700 mb-6 leading-relaxed font-medium bg-white p-3 rounded-xl border border-slate-100">${item.details || item.topic}</p>

                            ${item.assignments ? `
                                <div class="mb-4">
                                    <span class="text-xs font-black text-[#a200db] uppercase flex items-center gap-2 mb-2 tracking-wider"><i data-lucide="check-square" class="w-4 h-4"></i> Assignments</span>
                                    <p class="text-sm text-slate-800 bg-purple-50 p-3 rounded-xl border border-purple-100 font-bold">${item.assignments}</p>
                                </div>
                            ` : ''}

                            ${item.notes ? `
                                <div>
                                    <span class="text-xs font-black text-orange-500 uppercase flex items-center gap-2 mb-2 tracking-wider"><i data-lucide="sticky-note" class="w-4 h-4"></i> Observations</span>
                                    <p class="text-sm text-slate-600 italic bg-orange-50 p-3 rounded-xl border border-orange-100">${item.notes}</p>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');
            
            if(window.lucide) window.lucide.createIcons();
        }

        // OFFICIAL PDF REPORT
        document.getElementById('btn-pdf').onclick = () => {
            if(!window.jspdf) return;
            const doc = new window.jspdf.jsPDF();
            
            // Clean White Report
            doc.setFillColor(255, 255, 255); 
            doc.rect(0, 0, 210, 297, 'F'); 
            
            // Header
            doc.setTextColor(30, 41, 59); // Slate 800
            doc.setFontSize(18);
            doc.setFont("helvetica", "bold");
            doc.text("HOMESCHOOL INSTRUCTION LOG", 14, 20);
            
            doc.setFontSize(12);
            doc.setFont("helvetica", "normal");
            doc.text("Student: Gabriel Mendoza", 14, 28);
            
            doc.setTextColor(100);
            doc.setFontSize(10);
            doc.text(`Generated: ${new Date().toLocaleDateString()}`, 14, 35);

            let data = state.entries;
            // Use current view filter
            if(state.viewMode === 'daily') data = data.filter(e => e.date === state.viewDate);

            // Sort by date for PDF regardless of view mode
            data.sort((a,b) => new Date(b.date) - new Date(a.date));

            const rows = data.map(e => [
                e.date, 
                e.subject, 
                e.unit || '-', 
                e.topic || '-', // Lesson Name
                e.details || '-', // Details
                e.assignments||'', 
                e.notes||''
            ]);
            
            doc.autoTable({
                startY: 42,
                head: [['Date', 'Subject', 'Unit', 'Lesson Name', 'Details', 'Assign', 'Notes']],
                body: rows,
                theme: 'grid',
                headStyles: { fillColor: [248, 250, 252], textColor: [15, 23, 42], lineWidth: 0.1, lineColor: [203, 213, 225] },
                bodyStyles: { fillColor: [255, 255, 255], textColor: 50, lineColor: [226, 232, 240] },
                alternateRowStyles: { fillColor: [252, 252, 253] },
                styles: { fontSize: 8, cellPadding: 2 },
                columnStyles: { 4: { cellWidth: 40 } } // Wider column for details
            });
            doc.save('Gabriel_Homeschool_Record.pdf');
        };

    </script>
</body>
</html>
