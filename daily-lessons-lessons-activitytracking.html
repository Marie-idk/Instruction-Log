<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
    <title>Instruction Log</title>
    
    <!-- Google Fonts: Inter & Outfit -->
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;700;900&family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- jsPDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>

    <style>
        :root {
            --bg-page: #ffffff;
            --neon-blue: #00f2ea;
            --neon-pink: #ff0055;
            --neon-purple: #bd00ff;
            --neon-yellow: #ffec19;
            --neon-green: #00ff9d;
        }

        body, html {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-page);
            color: #18181b;
            height: 100%;
            overflow: hidden;
            -webkit-tap-highlight-color: transparent;
        }

        h1, h2, h3, h4, button, label {
            font-family: 'Outfit', sans-serif;
        }

        /* Bright Rainbow Text */
        .rainbow-text {
            background: linear-gradient(90deg, #ff0055, #bd00ff, #00f2ea);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-weight: 900;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));
        }

        /* Inputs */
        .neon-input {
            width: 100%;
            background-color: #f8fafc !important; /* Slightly grey to contrast with white card */
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 10px 12px;
            font-weight: 600;
            color: #1e293b;
            transition: all 0.2s;
            resize: none !important;
            appearance: none;
        }
        .neon-input:focus {
            outline: none;
            background-color: #ffffff !important;
            border-color: var(--neon-purple);
            box-shadow: 0 0 0 4px rgba(189, 0, 255, 0.1);
        }

        /* Toggle */
        .toggle-container {
            background: #f1f5f9;
            padding: 6px;
            border-radius: 999px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            position: relative;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.05);
        }
        .tab-bg {
            position: absolute;
            top: 6px; bottom: 6px; left: 6px;
            width: calc(50% - 6px);
            background: #fff;
            border-radius: 999px;
            border: 2px solid var(--neon-blue);
            box-shadow: 0 4px 12px rgba(0, 242, 234, 0.2);
            transition: transform 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 0;
        }
        .tab-btn { position: relative; z-index: 1; color: #64748b; transition: color 0.2s; }
        .tab-btn.active { color: #0f172a; font-weight: 900; }

        /* Save & PDF Button - High Energy */
        .btn-neon {
            background: linear-gradient(135deg, var(--neon-pink), var(--neon-purple));
            color: white;
            box-shadow: 0 4px 15px rgba(255, 0, 85, 0.3);
            transition: all 0.2s;
            border: 2px solid white;
        }
        .btn-neon:active { transform: scale(0.95); }
        .btn-neon:hover {
            box-shadow: 0 6px 20px rgba(189, 0, 255, 0.4);
            transform: translateY(-1px);
        }

        /* --- NEON RAINBOW BORDERS --- */
        .rainbow-card {
            background: #ffffff;
            border: 2px solid transparent; 
            border-radius: 16px;
            background-image: linear-gradient(#ffffff, #ffffff), linear-gradient(135deg, #ff0055, #bd00ff, #00f2ea);
            background-origin: border-box;
            background-clip: padding-box, border-box;
            box-shadow: 0 4px 15px rgba(189, 0, 255, 0.05);
            transition: all 0.3s ease;
            position: relative;
            z-index: 10;
        }
        .rainbow-card:hover {
            transform: translateY(-1px);
            box-shadow: 0 8px 25px rgba(0, 242, 234, 0.15);
            z-index: 20;
        }
        
        .rainbow-card-label {
            font-size: 0.75rem; /* text-xs */
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #64748b;
            margin-bottom: 0.5rem;
            display: block;
        }

        /* Timeline Details */
        .timeline-details {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out, padding 0.3s ease;
            background: #f8fafc;
            border-bottom-left-radius: 14px;
            border-bottom-right-radius: 14px;
        }
        .expanded .timeline-details {
            max-height: 1000px;
            padding: 1.5rem;
            border-top: 2px solid #f1f5f9;
        }
        .chevron { transition: transform 0.3s; }
        .expanded .chevron { transform: rotate(180deg); }
        
        .unit-chevron { transition: transform 0.3s; }
        .unit-expanded .unit-chevron { transform: rotate(90deg); }
        .unit-body { display: none; }
        .unit-expanded .unit-body { display: block; animation: slideDown 0.3s ease-out; }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Scrollbar */
        .scroller::-webkit-scrollbar { width: 4px; }
        .scroller::-webkit-scrollbar-thumb { background: transparent; border-radius: 3px; }
        .scroller:hover::-webkit-scrollbar-thumb { background: #cbd5e1; }
        .scroller::-webkit-scrollbar-track { background: transparent; }
        
        /* Force Button Visibility */
        .add-next-btn {
            display: inline-flex !important;
            visibility: visible !important;
            opacity: 1 !important;
            z-index: 50 !important;
        }
    </style>
</head>
<body class="flex flex-col h-screen">

    <!-- HEADER -->
    <header class="bg-white border-b border-slate-100 py-4 px-4 shrink-0 z-20">
        <div class="max-w-2xl mx-auto flex items-center justify-between">
            <h1 class="text-3xl tracking-tighter rainbow-text">InstructionnLOG</h1>
            
            <!-- Global Date Filter (For Daily View Only) -->
            <div id="date-nav-controls" class="flex items-center bg-slate-50 rounded-xl border border-slate-200 p-1">
                <button id="prev-date" class="p-2 text-slate-400 hover:text-indigo-600 hover:bg-white rounded-lg transition"><i data-lucide="chevron-left" class="w-6 h-6"></i></button>
                <div class="px-4 text-center min-w-[120px]">
                    <span id="date-display-text" class="text-base font-black text-slate-800 block">Today</span>
                </div>
                <button id="next-date" class="p-2 text-slate-400 hover:text-indigo-600 hover:bg-white rounded-lg transition"><i data-lucide="chevron-right" class="w-6 h-6"></i></button>
            </div>
            
            <!-- Filter Info (For Unit View) -->
            <div id="unit-view-badge" class="hidden px-4 py-2 bg-purple-50 text-[#bd00ff] font-black rounded-xl border border-purple-100 text-sm">
                UNIT VIEW
            </div>
        </div>
    </header>

    <!-- TABS -->
    <div class="bg-white px-4 py-4 shrink-0 z-10 shadow-sm">
        <div class="max-w-2xl mx-auto toggle-container">
            <div id="tab-bg" class="tab-bg"></div>
            <button onclick="switchTab('write')" id="tab-write" class="tab-btn active py-3 text-sm font-black text-center rounded-full tracking-wide">
                LOG ENTRY
            </button>
            <button onclick="switchTab('review')" id="tab-review" class="tab-btn py-3 text-sm font-black text-center rounded-full flex items-center justify-center gap-2 tracking-wide">
                VIEW RECORDS
            </button>
        </div>
    </div>

    <!-- MAIN CONTENT -->
    <main class="flex-1 overflow-hidden relative bg-white">
        <div class="max-w-2xl mx-auto h-full relative">
            
            <!-- WRITE VIEW -->
            <div id="view-write" class="absolute inset-0 overflow-y-auto scroller p-6 pb-32">
                <form id="journal-form" class="space-y-6">
                    
                    <!-- Date & Subject Card -->
                    <div class="rainbow-card p-4">
                        <label class="rainbow-card-label flex items-center gap-2"><i data-lucide="calendar" class="w-4 h-4 text-indigo-500"></i> Date & Subject</label>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <input type="date" id="input-date" class="neon-input cursor-pointer text-lg border-indigo-200" required>
                            </div>
                            <div class="relative">
                                <select id="input-subject" class="neon-input appearance-none cursor-pointer text-lg">
                                    <option value="Math">Math</option>
                                    <option value="Language Arts">Language Arts</option>
                                    <option value="Science">Science</option>
                                    <option value="History">History</option>
                                    <option value="Geography">Geography</option>
                                    <option value="Art">Art</option>
                                    <option value="Music">Music</option>
                                    <option value="PE">PE</option>
                                    <option value="Reading">Reading</option>
                                    <option value="Technology">Technology</option>
                                    <option value="Life Skills">Life Skills</option>
                                    <option value="Other">Other</option>
                                </select>
                                <i data-lucide="chevron-down" class="absolute right-4 top-1/2 -translate-y-1/2 w-5 h-5 text-slate-400 pointer-events-none"></i>
                            </div>
                        </div>

                        <!-- Type Selection within Card -->
                        <div class="grid grid-cols-3 gap-3 mt-4 pt-4 border-t border-slate-100">
                            <label class="cursor-pointer group">
                                <input type="radio" name="entryType" value="daily" class="peer hidden" checked>
                                <div class="py-2 text-center text-xs font-bold border-2 border-slate-100 bg-slate-50 rounded-lg text-slate-400 peer-checked:border-[#00f2ea] peer-checked:text-[#00c2bb] peer-checked:bg-cyan-50 transition-all">Daily</div>
                            </label>
                            <label class="cursor-pointer group">
                                <input type="radio" name="entryType" value="weekly" class="peer hidden">
                                <div class="py-2 text-center text-xs font-bold border-2 border-slate-100 bg-slate-50 rounded-lg text-slate-400 peer-checked:border-[#bd00ff] peer-checked:text-[#a200db] peer-checked:bg-purple-50 transition-all">Weekly</div>
                            </label>
                            <label class="cursor-pointer group">
                                <input type="radio" name="entryType" value="unit" class="peer hidden">
                                <div class="py-2 text-center text-xs font-bold border-2 border-slate-100 bg-slate-50 rounded-lg text-slate-400 peer-checked:border-[#ff0055] peer-checked:text-[#db0049] peer-checked:bg-pink-50 transition-all">Unit</div>
                            </label>
                        </div>
                    </div>

                    <!-- Unit & Context Card -->
                    <div class="rainbow-card p-4">
                        <label class="rainbow-card-label flex items-center gap-2"><i data-lucide="layers" class="w-4 h-4 text-purple-500"></i> Unit Context</label>
                        <div class="grid grid-cols-1 gap-4">
                            <div>
                                <label class="text-[10px] font-bold text-slate-400 uppercase mb-1 block">Work Type</label>
                                <input id="input-category" list="category-list" class="neon-input" value="Lesson">
                                <datalist id="category-list">
                                    <option value="Worksheet"></option>
                                    <option value="Lesson"></option>
                                    <option value="Project"></option>
                                    <option value="Quiz"></option>
                                    <option value="Reading"></option>
                                    <option value="Video"></option>
                                </datalist>
                            </div>
                            <div>
                                <label class="text-[10px] font-bold text-slate-400 uppercase mb-1 block">Unit / Module Name</label>
                                <input type="text" id="input-unit" class="neon-input" placeholder="e.g. Solar System">
                            </div>
                        </div>
                    </div>

                    <!-- Topic & Details Card -->
                    <div class="rainbow-card p-4">
                         <label class="rainbow-card-label flex items-center gap-2"><i data-lucide="book-open" class="w-4 h-4 text-pink-500"></i> Lesson Details</label>
                         <div class="space-y-4">
                            <div>
                                <label class="text-[10px] font-bold text-slate-400 uppercase mb-1 block">Topic / Lesson Name</label>
                                <input type="text" id="input-topic" class="neon-input text-lg font-bold text-indigo-700 bg-indigo-50" placeholder="e.g. The Sun's Gravity">
                            </div>
                            <div>
                                <label class="text-[10px] font-bold text-slate-400 uppercase mb-1 block">Activity Description</label>
                                <textarea id="input-details" class="neon-input min-h-[100px] text-base" placeholder="What specifically did we do?" required></textarea>
                            </div>
                         </div>
                    </div>

                    <!-- Assignments & Notes Card (Side-by-Side Fix) -->
                    <div class="rainbow-card p-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="space-y-2">
                                <label class="text-xs font-black text-[#00c2bb] uppercase ml-1 flex items-center gap-2"><i data-lucide="check-square" class="w-4 h-4"></i> Assignments</label>
                                <input type="text" id="input-assignments" class="neon-input bg-white border-slate-200" placeholder="pg. 42 #1-5">
                            </div>
                            <div class="space-y-2">
                                <label class="text-xs font-black text-[#db0049] uppercase ml-1 flex items-center gap-2"><i data-lucide="sticky-note" class="w-4 h-4"></i> Notes / Obs.</label>
                                <input type="text" id="input-notes" class="neon-input bg-white border-slate-200" placeholder="Progress notes...">
                            </div>
                        </div>
                    </div>

                    <div class="pt-4">
                        <button type="submit" id="save-btn" class="btn-neon w-full py-3 rounded-2xl text-lg font-black tracking-widest uppercase flex items-center justify-center gap-3">
                            <i data-lucide="save" class="w-5 h-5"></i> SAVE RECORD
                        </button>
                    </div>
                </form>
            </div>

            <!-- REVIEW VIEW (Timeline) -->
            <div id="view-review" class="absolute inset-0 overflow-y-auto scroller p-6 pb-32 hidden bg-white">
                
                <div class="flex justify-between items-center mb-8">
                    <h2 class="text-2xl font-black text-slate-800 tracking-tight">RECORDS</h2>
                    <div class="flex gap-2">
                        <select id="view-filter" onchange="setView(this.value)" class="bg-slate-100 text-slate-700 border-none text-sm font-bold rounded-xl px-4 py-3 outline-none cursor-pointer hover:bg-slate-200 transition">
                            <option value="daily">Daily View</option>
                            <option value="unit">By Unit (Flow)</option>
                            <option value="subject">By Subject</option>
                        </select>
                        <!-- PDF Button -->
                        <button id="btn-pdf" class="hidden btn-neon p-3 rounded-xl hover:scale-105 transition shadow-lg" title="Download Official Record">
                            <i data-lucide="printer" class="w-5 h-5 text-white"></i>
                        </button>
                    </div>
                </div>

                <div id="timeline-container" class="space-y-6">
                    <!-- Dynamic Content -->
                </div>
                
                <div id="empty-state" class="hidden flex flex-col items-center justify-center py-20 opacity-50">
                    <div class="w-20 h-20 bg-slate-100 rounded-full flex items-center justify-center mb-4">
                        <i data-lucide="book-open" class="w-10 h-10 text-slate-300"></i>
                    </div>
                    <p class="font-bold text-slate-400 text-lg">No records found.</p>
                </div>
            </div>
            
            <!-- Cancel Overlay -->
            <button type="button" id="cancel-edit-btn" class="hidden fixed bottom-6 left-1/2 -translate-x-1/2 bg-rose-600 text-white px-8 py-3 rounded-full shadow-[0_10px_30px_rgba(225,29,72,0.4)] font-black tracking-wide z-50 cursor-pointer hover:scale-105 transition-transform border-4 border-white active:scale-95" onclick="cancelEdit()">
                CANCEL EDIT
            </button>

        </div>
    </main>

    <!-- FIREBASE & LOGIC -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, deleteDoc, setDoc, doc, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyCBGNaOM_gv8X2DZZqAija6XakbdaTorS0",
            authDomain: "e-notion.firebaseapp.com",
            projectId: "e-notion",
            storageBucket: "e-notion.firebasestorage.app",
            messagingSenderId: "668075829380",
            appId: "1:668075829380:web:d31d7e74209e2f44e9bad1",
            measurementId: "G-X09RV55WSD"
        };
        const appId = 'e-notion'; 

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const state = {
            user: null,
            entries: [],
            rawUser: [],
            rawPublic: [],
            activeTab: 'write',
            viewMode: 'daily',
            viewDate: new Date().toISOString().split('T')[0],
            editingId: null,
            isSaving: false
        };

        // AUTH
        signInAnonymously(auth).catch(err => console.error(err));

        onAuthStateChanged(auth, (user) => {
            state.user = user;
            if(user) {
                const userRef = collection(db, 'artifacts', appId, 'users', user.uid, 'daily_journal');
                const publicRef = collection(db, 'artifacts', appId, 'public', 'data', 'daily_journal');
                
                onSnapshot(userRef, (s) => { state.rawUser = s.docs.map(d => ({id: d.id, ...d.data()})); refresh(); });
                onSnapshot(publicRef, (s) => { state.rawPublic = s.docs.map(d => ({id: d.id, ...d.data()})); refresh(); });
            }
        });

        function refresh() {
            const all = [...state.rawUser, ...state.rawPublic];
            const unique = Array.from(new Map(all.map(item => [item.id, item])).values());
            
            // Global Sort: Date DESC, then Time DESC
            unique.sort((a, b) => {
                if(a.date > b.date) return -1;
                if(a.date < b.date) return 1;
                const ta = a.createdAt?.seconds || 0;
                const tb = b.createdAt?.seconds || 0;
                return tb - ta;
            });

            state.entries = unique;
            updateUI();
        }

        function updateUI() {
            document.getElementById('btn-pdf').classList.toggle('hidden', state.entries.length === 0);
            if(state.activeTab === 'review') renderTimeline();
        }

        window.switchTab = (tab) => {
            state.activeTab = tab;
            const bg = document.getElementById('tab-bg');
            const btnWrite = document.getElementById('tab-write');
            const btnReview = document.getElementById('tab-review');
            const viewWrite = document.getElementById('view-write');
            const viewReview = document.getElementById('view-review');

            if(tab === 'write') {
                bg.style.transform = 'translateX(0)';
                btnWrite.classList.add('active');
                btnReview.classList.remove('active');
                viewWrite.classList.remove('hidden');
                viewReview.classList.add('hidden');
            } else {
                bg.style.transform = 'translateX(100%)';
                btnWrite.classList.remove('active');
                btnReview.classList.add('active');
                viewWrite.classList.add('hidden');
                viewReview.classList.remove('hidden');
                renderTimeline();
            }
        };

        // UI Interactions
        window.toggleDetails = (id) => {
            const card = document.getElementById(`card-${id}`);
            if(card) card.classList.toggle('expanded');
        }

        window.toggleUnitGroup = (unitId) => {
            const el = document.getElementById(unitId);
            if(el) el.classList.toggle('unit-expanded');
        }

        window.setView = (mode) => {
            state.viewMode = mode;
            // Toggle Date Nav visibility
            const nav = document.getElementById('date-nav-controls');
            const badge = document.getElementById('unit-view-badge');
            
            if(mode === 'daily') {
                nav.classList.remove('hidden');
                badge.classList.add('hidden');
            } else {
                nav.classList.add('hidden');
                badge.classList.remove('hidden');
                badge.innerText = mode === 'unit' ? 'UNIT VIEW' : 'SUBJECT VIEW';
            }
            renderTimeline();
        }

        window.cancelEdit = () => {
            state.editingId = null;
            document.getElementById('save-btn').innerHTML = `<i data-lucide="save" class="w-5 h-5"></i> SAVE RECORD`;
            document.getElementById('cancel-edit-btn').classList.add('hidden');
            document.getElementById('journal-form').reset();
            document.getElementById('input-date').value = state.viewDate;
            if(window.lucide) window.lucide.createIcons();
        }

        // HELPERS
        function formatDateForDisplay(isoDate) {
            if (!isoDate) return '';
            const [y, m, d] = isoDate.split('-');
            return `${m}-${d}-${y}`;
        }
        
        function getSubjectColor(s) {
            if(s.includes("Math")) return { bg: "bg-cyan-50", text: "text-[#00c2bb]", border: "border-cyan-200", icon: "calculator" };
            if(s.includes("Science")) return { bg: "bg-green-50", text: "text-emerald-500", border: "border-emerald-200", icon: "flask-conical" };
            if(s.includes("History")) return { bg: "bg-orange-50", text: "text-orange-500", border: "border-orange-200", icon: "landmark" };
            if(s.includes("Language")) return { bg: "bg-pink-50", text: "text-[#db0049]", border: "border-pink-200", icon: "feather" };
            if(s.includes("Reading")) return { bg: "bg-purple-50", text: "text-[#a200db]", border: "border-purple-200", icon: "book-open" };
            if(s.includes("Tech")) return { bg: "bg-blue-50", text: "text-blue-600", border: "border-blue-200", icon: "cpu" };
            return { bg: "bg-slate-100", text: "text-slate-500", border: "border-slate-200", icon: "circle" };
        }

        function setViewDate(iso) {
            state.viewDate = iso;
            const today = new Date().toISOString().split('T')[0];
            const displayDate = (iso === today) ? 'Today' : formatDateForDisplay(iso);
            document.getElementById('date-display-text').innerText = displayDate;
            
            if(!state.editingId) document.getElementById('input-date').value = iso;
            updateUI();
        }
        
        // INIT DATE
        document.getElementById('input-date').value = state.viewDate;
        setViewDate(state.viewDate);

        document.getElementById('prev-date').onclick = () => {
            const d = new Date(state.viewDate); d.setDate(d.getDate()-1);
            setViewDate(d.toISOString().split('T')[0]);
        };
        document.getElementById('next-date').onclick = () => {
            const d = new Date(state.viewDate); d.setDate(d.getDate()+1);
            setViewDate(d.toISOString().split('T')[0]);
        };

        // SAVE LOGIC
        document.getElementById('journal-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            if(state.isSaving || !state.user) return;
            state.isSaving = true;
            
            const btn = document.getElementById('save-btn');
            const originalHTML = btn.innerHTML;
            btn.innerText = "SAVING...";

            const formDate = document.getElementById('input-date').value;

            const entry = {
                date: formDate, 
                type: document.querySelector('input[name="entryType"]:checked').value,
                subject: document.getElementById('input-subject').value,
                category: document.getElementById('input-category').value,
                unit: document.getElementById('input-unit').value,
                topic: document.getElementById('input-topic').value,
                details: document.getElementById('input-details').value, 
                assignments: document.getElementById('input-assignments').value,
                notes: document.getElementById('input-notes').value,
                updatedAt: serverTimestamp()
            };

            try {
                if(state.editingId) {
                    await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'daily_journal', state.editingId), entry, {merge:true});
                    state.editingId = null;
                    document.getElementById('cancel-edit-btn').classList.add('hidden');
                } else {
                    entry.createdAt = serverTimestamp();
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'daily_journal'), entry);
                }

                // If in Daily View, jump to date. If in Unit View, just refresh.
                if(state.viewMode === 'daily') setViewDate(formDate);

                // Reset specific fields
                document.getElementById('input-topic').value = '';
                document.getElementById('input-details').value = '';
                document.getElementById('input-assignments').value = '';
                document.getElementById('input-notes').value = '';
                
                btn.innerText = "RECORD SAVED!";
                setTimeout(() => {
                    btn.innerHTML = `<i data-lucide="save" class="w-5 h-5"></i> SAVE RECORD`;
                    if(window.lucide) window.lucide.createIcons();
                }, 1500);

            } catch(err) {
                alert("Error: " + err.message);
                btn.innerHTML = originalHTML;
            } finally {
                state.isSaving = false;
            }
        });

        // EDIT & LINK
        window.editEntry = (id) => {
            const item = state.entries.find(e => e.id === id);
            if(!item) return;
            event.stopPropagation();

            state.editingId = id;
            document.getElementById('input-date').value = item.date;
            
            const radio = document.querySelector(`input[name="entryType"][value="${item.type || 'daily'}"]`);
            if(radio) radio.checked = true;

            document.getElementById('input-subject').value = item.subject;
            document.getElementById('input-category').value = item.category;
            document.getElementById('input-unit').value = item.unit;
            document.getElementById('input-topic').value = item.topic;
            document.getElementById('input-details').value = item.details || ''; 
            document.getElementById('input-assignments').value = item.assignments;
            document.getElementById('input-notes').value = item.notes;

            document.getElementById('save-btn').innerText = "UPDATE RECORD";
            document.getElementById('cancel-edit-btn').classList.remove('hidden');
            
            switchTab('write');
        };

        window.continueUnit = (id) => {
            const item = state.entries.find(e => e.id === id);
            if(!item) return;
            event.stopPropagation();

            state.editingId = null; 
            document.getElementById('cancel-edit-btn').classList.add('hidden'); 
            document.getElementById('save-btn').innerHTML = `<i data-lucide="save" class="w-5 h-5"></i> SAVE RECORD`;

            const today = new Date().toISOString().split('T')[0];
            document.getElementById('input-date').value = today;
            
            document.getElementById('input-subject').value = item.subject;
            document.getElementById('input-category').value = item.category;
            document.getElementById('input-unit').value = item.unit; // Key to linking!
            
            document.getElementById('input-topic').value = ''; 
            document.getElementById('input-details').value = ''; 
            document.getElementById('input-assignments').value = '';
            document.getElementById('input-notes').value = '';

            switchTab('write');
        };

        window.deleteEntry = async (id) => {
            event.stopPropagation();
            if(confirm("Delete this record?")) {
                await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'daily_journal', id));
                if(state.user) await deleteDoc(doc(db, 'artifacts', appId, 'users', state.user.uid, 'daily_journal', id)).catch(e=>{});
            }
        };

        // RENDER LOGIC
        function renderTimeline() {
            const container = document.getElementById('timeline-container');
            const empty = document.getElementById('empty-state');
            
            let data = [...state.entries];

            if(data.length === 0) {
                container.innerHTML = '';
                empty.classList.remove('hidden');
                return;
            }
            empty.classList.add('hidden');

            // --- VIEW MODE 1: DAILY ---
            if(state.viewMode === 'daily') {
                data = data.filter(e => e.date === state.viewDate);
                if(data.length === 0) {
                    container.innerHTML = '';
                    empty.classList.remove('hidden');
                    return;
                }
                container.innerHTML = data.map(item => renderCard(item)).join('');
            } 
            
            // --- VIEW MODE 2: UNIT (The Requested "Linked" View) ---
            else if (state.viewMode === 'unit') {
                // Group by Unit Name (or "Uncategorized")
                const groups = {};
                
                data.forEach(item => {
                    const key = item.unit && item.unit.trim() !== "" ? item.unit : "Uncategorized Lessons";
                    if(!groups[key]) {
                        groups[key] = {
                            name: key,
                            subject: item.subject, // Grab subject from first item
                            items: []
                        };
                    }
                    groups[key].items.push(item);
                });

                // Convert to array and sort by "Most recent lesson in group"
                const sortedGroups = Object.values(groups).sort((a,b) => {
                    const maxDateA = new Date(Math.max(...a.items.map(i => new Date(i.date))));
                    const maxDateB = new Date(Math.max(...b.items.map(i => new Date(i.date))));
                    return maxDateB - maxDateA;
                });

                container.innerHTML = sortedGroups.map((group, index) => {
                    // Sort items inside group by Date Ascending (Flow)
                    group.items.sort((a,b) => new Date(a.date) - new Date(b.date));
                    
                    const groupId = `unit-group-${index}`;
                    const style = getSubjectColor(group.subject || "Other");
                    const count = group.items.length;
                    
                    // Render children
                    const childrenHTML = group.items.map((item, i) => {
                        const isLast = i === group.items.length - 1;
                        return `
                            <div class="relative pl-8 pb-4 ${isLast ? 'last-item' : ''}">
                                <!-- Visual Connector Line -->
                                <div class="absolute left-[11px] top-6 bottom-[-10px] w-0.5 bg-slate-200 z-0 ${isLast ? 'hidden' : 'block'}"></div>
                                <!-- Visual Dot -->
                                <div class="absolute left-0 top-1.5 w-6 h-6 rounded-full bg-white border-4 ${style.border} z-10"></div>
                                
                                ${renderCard(item, true)} 
                            </div>
                        `;
                    }).join('');

                    // Add "Add Next" button at the end of the chain
                    const lastItem = group.items[group.items.length - 1];
                    const addBtnHTML = `
                         <div class="relative pl-8 pt-2">
                             <div class="absolute left-[11px] top-[-10px] h-6 w-0.5 bg-slate-200 z-0"></div>
                             <button onclick="continueUnit('${lastItem.id}')" class="flex items-center gap-2 text-xs font-black uppercase text-slate-400 hover:text-indigo-600 transition-colors bg-slate-50 hover:bg-white border border-slate-200 hover:border-indigo-200 rounded-full px-4 py-2 shadow-sm">
                                <i data-lucide="plus-circle" class="w-4 h-4"></i> Add Next Lesson to "${group.name}"
                             </button>
                         </div>
                    `;

                    return `
                        <div id="${groupId}" class="unit-group-container">
                            <div class="unit-group-card rainbow-card flex items-center justify-between" onclick="toggleUnitGroup('${groupId}')">
                                <div class="flex items-center gap-4">
                                    <div class="w-10 h-10 rounded-xl ${style.bg} flex items-center justify-center ${style.text}">
                                        <i data-lucide="${style.icon}" class="w-5 h-5"></i>
                                    </div>
                                    <div>
                                        <h3 class="font-black text-slate-700 text-lg leading-tight">${group.name}</h3>
                                        <span class="text-xs font-bold text-slate-400 uppercase tracking-wide">${count} Lessons â€¢ ${group.subject}</span>
                                    </div>
                                </div>
                                <i data-lucide="chevron-right" class="w-5 h-5 text-slate-300 unit-chevron"></i>
                            </div>
                            
                            <div class="unit-body mt-4 ml-5 pl-2 border-l-2 border-slate-100">
                                ${childrenHTML}
                                ${addBtnHTML}
                            </div>
                        </div>
                    `;
                }).join('');

            } 
            
            // --- VIEW MODE 3: SUBJECT ---
            else if (state.viewMode === 'subject') {
                data.sort((a,b) => a.subject.localeCompare(b.subject));
                container.innerHTML = data.map(item => renderCard(item)).join('');
            }

            if(window.lucide) window.lucide.createIcons();
        }

        // Helper to render a single card
        function renderCard(item, isCompact = false) {
            const style = getSubjectColor(item.subject || 'Other');
            const dateDisplay = `<span class="text-[10px] font-bold text-slate-400 bg-slate-50 px-2 py-0.5 rounded-md whitespace-nowrap">${formatDateForDisplay(item.date)}</span>`;
            
            // If compact (inside Unit view), hide the Subject Icon since the group header has it
            const iconHTML = isCompact ? '' : `
                <div class="w-10 h-10 rounded-xl ${style.bg} flex items-center justify-center ${style.text} shadow-sm shrink-0 mt-1">
                    <i data-lucide="${style.icon}" class="w-5 h-5"></i>
                </div>`;

            return `
                <div class="timeline-card rainbow-card cursor-pointer group mb-4" id="card-${item.id}" onclick="toggleDetails('${item.id}')">
                    <div class="p-4">
                        <div class="flex items-start justify-between gap-3">
                            <div class="flex items-start gap-3 flex-1 min-w-0">
                                ${iconHTML}
                                <div class="overflow-hidden flex-1">
                                    <div class="flex items-center gap-2 mb-1 flex-wrap">
                                        ${!isCompact ? `<span class="text-[10px] font-black uppercase text-slate-500 bg-slate-100 px-2 py-0.5 rounded-md tracking-wider whitespace-nowrap">${item.subject}</span>` : ''}
                                        ${dateDisplay}
                                    </div>
                                    <div class="flex flex-col">
                                        ${item.unit && !isCompact ? `<span class="text-[10px] font-bold text-slate-400 uppercase tracking-wide mb-0.5 truncate">${item.unit}</span>` : ''}
                                        <h3 class="font-bold text-slate-800 text-base leading-tight">${item.topic || 'Untitled Lesson'}</h3>
                                    </div>
                                </div>
                            </div>
                            <div class="shrink-0 mt-2">
                                <i data-lucide="chevron-down" class="w-5 h-5 text-slate-400 chevron group-hover:text-indigo-600 transition-colors"></i>
                            </div>
                        </div>
                    </div>

                    <div class="timeline-details">
                        <div class="flex justify-end gap-3 mb-4">
                            <button onclick="editEntry('${item.id}')" class="text-xs font-black text-indigo-600 hover:text-indigo-800 uppercase bg-indigo-50 px-3 py-1.5 rounded-lg transition-colors">Edit</button>
                            <button onclick="deleteEntry('${item.id}')" class="text-xs font-black text-rose-600 hover:text-rose-800 uppercase bg-rose-50 px-3 py-1.5 rounded-lg transition-colors">Delete</button>
                        </div>

                        <h4 class="text-xs font-black text-slate-400 uppercase mb-2 tracking-wider">Activity Details</h4>
                        <p class="text-sm text-slate-700 mb-6 leading-relaxed font-medium bg-white p-3 rounded-xl border border-slate-100">${item.details || item.topic}</p>

                        ${item.assignments ? `
                            <div class="mb-4">
                                <span class="text-xs font-black text-[#a200db] uppercase flex items-center gap-2 mb-2 tracking-wider"><i data-lucide="check-square" class="w-4 h-4"></i> Assignments</span>
                                <p class="text-sm text-slate-800 bg-purple-50 p-3 rounded-xl border border-purple-100 font-bold">${item.assignments}</p>
                            </div>
                        ` : ''}

                        ${item.notes ? `
                            <div>
                                <span class="text-xs font-black text-orange-500 uppercase flex items-center gap-2 mb-2 tracking-wider"><i data-lucide="sticky-note" class="w-4 h-4"></i> Observations</span>
                                <p class="text-sm text-slate-600 italic bg-orange-50 p-3 rounded-xl border border-orange-100">${item.notes}</p>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
        }

        // PDF GENERATION (PROFESSIONAL FIX)
        document.getElementById('btn-pdf').onclick = () => {
            if(!window.jspdf) return;
            const doc = new window.jspdf.jsPDF();
            const pageWidth = doc.internal.pageSize.getWidth();
            
            // -- HEADER --
            doc.setFillColor(255, 255, 255);
            doc.rect(0, 0, 210, 297, 'F');
            
            // School/Homeschool Title
            doc.setTextColor(30, 41, 59); // Slate 800
            doc.setFontSize(22);
            doc.setFont("helvetica", "bold");
            doc.text("HOMESCHOOL INSTRUCTION LOG", 14, 22);
            
            // Student Details
            doc.setFontSize(10);
            doc.setFont("helvetica", "bold");
            doc.text("STUDENT:", 14, 32);
            doc.setFont("helvetica", "normal");
            doc.text("Gabriel Mendoza", 35, 32);

            doc.setFont("helvetica", "bold");
            doc.text("DATE GENERATED:", 14, 38);
            doc.setFont("helvetica", "normal");
            doc.text(new Date().toLocaleDateString(), 55, 38);

            // Divider Line
            doc.setDrawColor(203, 213, 225); // Slate 300
            doc.setLineWidth(0.5);
            doc.line(14, 45, pageWidth - 14, 45);

            // -- DATA PREP --
            // FIX: Always grab ALL entries, sort by date descending
            let data = [...state.entries];
            data.sort((a,b) => new Date(b.date) - new Date(a.date));

            const rows = data.map(e => [
                formatDateForDisplay(e.date), 
                e.subject, 
                e.unit || '-', 
                e.topic || '-', 
                e.details || '-', 
                e.assignments||'', 
                e.notes||''
            ]);
            
            // -- TABLE --
            doc.autoTable({
                startY: 50,
                head: [['Date', 'Subject', 'Unit', 'Lesson / Topic', 'Activity Details', 'Assignments', 'Notes']],
                body: rows,
                theme: 'grid',
                headStyles: { 
                    fillColor: [30, 41, 59], // Slate 800 (Professional Dark)
                    textColor: [255, 255, 255], 
                    fontStyle: 'bold',
                    fontSize: 8,
                    halign: 'center'
                },
                bodyStyles: { 
                    fillColor: [255, 255, 255], 
                    textColor: [51, 65, 85], 
                    fontSize: 8,
                    cellPadding: 3,
                    valign: 'top'
                },
                alternateRowStyles: { 
                    fillColor: [248, 250, 252] // Slate 50
                },
                columnStyles: { 
                    0: { cellWidth: 20 }, // Date
                    1: { cellWidth: 20 }, // Subject
                    2: { cellWidth: 25 }, // Unit
                    3: { cellWidth: 30 }, // Lesson
                    4: { cellWidth: 'auto' }, // Details (Flexible)
                    5: { cellWidth: 25 }, // Assign
                    6: { cellWidth: 25 }  // Notes
                },
                didDrawPage: function (data) {
                    // Footer
                    doc.setFontSize(8);
                    doc.setTextColor(150);
                    doc.text('Page ' + doc.internal.getNumberOfPages(), pageWidth - 20, doc.internal.pageSize.getHeight() - 10);
                }
            });
            
            doc.save('Gabriel_Homeschool_Official_Record.pdf');
        };

    </script>
</body>
</html>

